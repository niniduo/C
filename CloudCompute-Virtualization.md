

[TOC]

# 云计算与虚拟化

## 云计算

### 定义

云计算是一种模型而非技术，云计算是一种通过互联网，以服务的方式提供动态可伸缩的虚拟化资源的计算模式

### 传统IT架构的缺点

​	业务上线慢
​	扩展困难
​	可靠性不强
​	生命周期管理复杂
​	I/O瓶颈导致延迟
​	TCO高不下(Total Cost of Ownership（总体拥有成本））

### 云计算的优势

​	1.按需自助服务

​	2.无处不在的网络接入

​	3.与位置无关资源池

​	3.快速弹性伸缩

​	4.可以按需计费（计量服务）

### 部署模式

1. #### 公有云

   + 最广泛，由运营商提供（面向大众）

2. #### 私有云

   + 最安全，企业或单位的内部

3. #### 行业云/社区云

   + 面向某个行业当中的人员，以公开或者半公开的方式使用

4. #### 混合云

   + 兼并各种云的特点，淘宝

## 虚拟化

<img src="C:\Users\27212\AppData\Roaming\Typora\typora-user-images\image-20230420192204972.png" alt="image-20230420192204972" style="zoom:50%;" />

### [hypervisor和VMM](https://zhuanlan.zhihu.com/p/185946700)

+ guest os 虚拟机操作系统，guest 虚拟机

+ Hypervisor——一种运行在基础物理[服务器](https://cloud.tencent.com/product/cvm?from=20065&from_column=20065)和操作系统之间的中间软件层,可允许多个操作系统和应用共享硬件。也可叫做VMM（ virtual machine monitor ），即虚拟机监视器。

  Hypervisors是一种在虚拟环境中的“元”操作系统。他们可以访问服务器上包括磁盘和内存在内的所有物理设备。Hypervisors不但协调着这些硬件资源的访问，而且在各个虚拟机之间施加防护。当服务器启动并执行Hypervisor时，它会加载所有虚拟机客户端的操作系统同时会分配给每一台虚拟机适量的内存，CPU，网络和磁盘。

### 定义

​	借助虚拟化技术，以单个物理硬件系统为基础创建多个模拟环境或专用资源（Redhat）

### 特点

1. 分区：一套硬件运行多个操作系统
2. 隔离：各个操作系统之间互不影响
3. 封装：虚拟机（不同的操作系统封装成独立文件），使其可以灵活的迁移（数据更加的安全，只要硬盘没坏）
4. 相对于硬件独立：兼容性更高，迁移是对硬件类型（版本）的几乎没有要求，可以在任何不同类型的服务器上运行

### 主流的虚拟化技术

1. ### KVM

   1. KVM 是硬件辅助的虚拟化技术

   2. 基于内核的虚拟机（KVM）是一种内建于 Linux的[开源](https://www.redhat.com/zh/topics/open-source/what-is-open-source)[虚拟化](https://www.redhat.com/zh/topics/virtualization/what-is-virtualization)技术（极致的性能）

   3. 简单点说

      例如在Windows上我们可以通过VMware或者VBox等软件安装虚拟机，而KVM类似于linux上的软件（不过被写在了内核中，是系统的一部分）

2. ### Xen

   服务器启动后出现一个特殊权限的虚拟机:Domain0虚拟机，并且Domain0之后生成的其他虚拟机不可以直接控制硬件,  需要告诉Domain0，让Domain0去识别并且判断是都执行，相对来说更加的安全

3. **[Qemu](https://zhuanlan.zhihu.com/p/72484589)**

   **<u>Qemu 是纯软件实现的虚拟化模拟器</u>**，几乎可以模拟任何硬件设备，我们最熟悉的就是能够模拟一台能够独立运行操作系统的虚拟机，虚拟机认为自己和硬件打交道，但其实是和 Qemu 模拟出来的硬件打交道，Qemu 将这些指令转译给真正的硬件。

   正因为 Qemu 是纯软件实现的，所有的指令都要经 Qemu 过一手，性能非常低，所以，在生产环境中，大多数的做法都是配合 KVM 来完成虚拟化工作，因为 **<u>KVM 是硬件辅助的虚拟化技术</u>**，主要负责 比较繁琐的 CPU 和内存虚拟化，而 Qemu 则负责 I/O 虚拟化，两者合作各自发挥自身的优势，相得益彰。

### 虚拟化主要类型

### [CPU虚拟化](https://blog.51cto.com/tasnrh/1736758#:~:text=CPU%E7%BA%AF%E8%BD%AF%E4%BB%B6%E5%85%A8%E8%99%9A%E6%8B%9F%E5%8C%96%E6%8A%80%E6%9C%AF%201%201%E3%80%81%E6%A8%A1%E6%8B%9F%E4%BB%BF%E7%9C%9F%E6%8A%80%E6%9C%AF%20%E6%9C%80%E5%85%88%E5%AE%9E%E7%8E%B0%E8%BF%99%E7%A7%8DCPU%E5%85%A8%E8%99%9A%E6%8B%9F%E5%8C%96%E6%8A%80%E6%9C%AF%E7%9A%84%E6%98%AFTrap-and-emulation%E6%8A%80%E6%9C%AF%EF%BC%8C%E5%8D%B3%E9%99%B7%E5%85%A5%E6%A8%A1%E5%BC%8F%E5%92%8C%E6%A8%A1%E6%8B%9F%E4%BB%BF%E7%9C%9F%E6%8A%80%E6%9C%AF%E3%80%82%20%E8%BF%99%E7%A7%8D%E6%8A%80%E6%9C%AF%E9%80%9A%E8%BF%87%E5%B0%86OS%E9%9C%80%E6%B1%82%E7%9A%84%E7%89%B9%E6%9D%83%E6%8C%87%E4%BB%A4%E9%80%9A%E8%BF%87VMM%E8%87%AA%E5%8A%A8%E6%8D%95%E8%8E%B7%E7%9A%84%E6%96%B9%E5%BC%8F%E8%BF%90%E8%A1%8C%E5%90%8E%E8%BF%94%E5%9B%9E%E5%8E%BBOS%E3%80%82%20...%202%202%E3%80%81%E4%BA%8C%E8%BF%9B%E5%88%B6%E7%BF%BB%E8%AF%91%E6%8A%80%E6%9C%AF,SIDT%20%E2%80%A6%20%E7%94%B1%E4%BA%8E%E6%A8%A1%E6%8B%9F%E4%BB%BF%E7%9C%9F%E6%8A%80%E6%9C%AF%E5%9B%BA%E6%9C%89%E7%9A%84%E7%BC%BA%E9%99%B7%EF%BC%8C%E5%AF%BC%E8%87%B4%E5%AF%B9CPU%E7%9A%84%E8%99%9A%E6%8B%9F%E5%8C%96%E5%B9%B6%E4%B8%8D%E5%AE%8C%E6%95%B4%E3%80%82%20...%203%203%E3%80%81%E6%80%BB%E7%BB%93%20%E5%9C%A8%E6%B2%A1%E6%9C%89CPU%E7%A1%AC%E4%BB%B6%E8%BE%85%E5%8A%A9%E8%99%9A%E6%8B%9F%E5%8C%96%E6%8A%80%E6%9C%AF%E4%B9%8B%E5%89%8D%EF%BC%8C%E5%AF%B9%E4%BA%8EX86%E6%9E%B6%E6%9E%84%E7%9A%84CPU%E5%B0%B1%E9%87%87%E7%94%A8%E6%A8%A1%E6%8B%9F%E5%92%8C%E4%BA%8C%E8%BF%9B%E5%88%B6%E7%BF%BB%E8%AF%91%E7%9A%84%E6%8A%80%E6%9C%AF%E5%AF%B9CPU%E8%BF%9B%E8%A1%8C%E8%99%9A%E6%8B%9F%E5%8C%96%E5%AE%9E%E7%8E%B0%EF%BC%8C%E4%BD%86%E6%98%AF%E6%A8%A1%E6%8B%9F%E7%9A%84%E6%96%B9%E5%BC%8F%E5%AD%98%E5%9C%A8%E5%9B%BA%E6%9C%89%E7%BC%BA%E9%99%B7%EF%BC%8C%E5%B9%B6%E4%B8%8D%E5%AE%8C%E5%85%A8%E8%99%9A%E6%8B%9F%E5%8C%96%E4%BA%86x86%E7%9A%84CPU%E6%9E%B6%E6%9E%84%E3%80%82%20)

### CPU指令

+ 特权指令：系统中有一些操作和管理关键系统资源的指令，这些指令只有在最高特权级上能够正确运行。如果在非最高特权级上运行，<u>特权指令会引发一个异常</u>，处理器会陷入到最高特权级，交由系统软件处理了。在不同的运行级别上，指令的执行效果不同，而且并不是每个特权指令都会引发异常，它有可能被直接忽略。硬件区分特权指令和普通指令的目的，举个例子，就像操作系统提供系统调用一样。

+ 敏感指令：操作特权资源的指令，包括修改虚拟机的运行模式或者下面物理机的状态；读写时钟、中断等寄存器；访问存储保护系统、地址重定位系统及所有的I/O指令。<u>不会触发异常的特权指令也是敏感指令；也就是说，敏感指令范围更大，有些敏感指令不能触发异常，这是x86设计的设计原因。</u>

  

**如何正确的捕获和处理虚拟机下发的敏感指令（虚拟化的发展过程，以CPU为例）**

**完全虚拟化（full virtualization）**

+ 完全虚拟化场景下，要求将GuestOS内核的特权解除，从原来的0降低到1或者3。这部分特权指令在GuestOS中发生的时候，就会产生Trap，被VMM捕获，从而由VMM处理完下发给宿主机OS。这就是完全虚拟话的本质方法，特权解除和陷入模拟(Privilege deprivileging/Trap-and-Emulation)。虚拟化场景中敏感指令必须被VMM捕获并完成。对于一般 RISC 处理器，如 MIPS，PowerPC 以及SPARC，敏感指令肯定是特权指令，但是x86 例外，x86绝大多数的敏感指令是特权指令，但是由部分敏感指令不是特权指令，执行这些指令的时候不会自动trap被VMM捕获。

+ 然后VMware出了一个主意，VMM层加一个BT（二进制翻译），相当于安检，所有指令被捕获到BT翻译成X86指令集，判断指令是否为敏感指令，如果是非敏感指令，就直接给宿主机OS执行，如果是敏感指令就下发给VMM处理（将敏感指令处理成非敏感指令，这条指令既不影响宿主机CPU的正常运行，又可以达到处理前被认定为敏感指令想要的效果，让虚拟机OS认为自己的指令执行成功了）

+ 这种技术也就是完全虚拟化技术，但是所有的指令都需要经过BT，加大了CPU的负载，降低了CPU的运行效率，但是兼容性很强

+ 在完全虚拟化技术的基础上，人们想出了一些办法提高性能，例如加缓存机制来避免重复的非敏感指令经过DBT，而是直接下发给宿主机OS,还有就是，直接对用户层指令开绿灯，绕过DBT和VMM,加快运行

**半虚拟化（para virtualization）**

+ 虚拟机OS位于Ring1级别，但是不主动的去捕捉命令，然后识别，而是被动的让虚拟机OS告诉vmm哪些是敏感指令，然后我直接给VMM处理

+ (虚拟机OS知道自己运行在虚拟化环境中的，通过更改虚拟机OS操作系统内核实现主动把敏感指令下发给VMM，但是通过hypercall的方式调用Ring0的VMM处理）

+ 性能提高，但是兼容变差（现在主流的操作系统并不是为虚拟化设计的，操作系统没有主动调用hypercall的逻辑，需要对内核进行修改才能拥有这样的能力，开源的可以办到，但是不开源的非常难实现）

  

+ 对于x86体系结构CPU，Xen使用超级调用来替换被监控的操作，其中包括x86架构下的敏感指令。Xen所采用的超级替换的方法是一种全新的设计理念：它将问题的中心，由VMM移向Guest OS自身，通过主动的方式由Guest OS去处理这些指令，而不是被移交给VMM做处理，在这种设计理念下，修改Guest OS内核。

  能修改Guest OS是半虚拟化的一个技术核心。通过修改Guest OS的内核。使Guest OS明确知道自己是运行在1环上，而不是通常OS的0环，有效的避免了虚拟化的执行冲突问题。Guest OS也清楚VMM给自己提供了一个虚拟的寄存器组，并能通过其他方式去访问他们，避免了访问冲突的问题。

      解决了敏感指令问题只是解决了x86架构下的半虚拟化的第一步。运行在1环的操作系统没有权限执行的指令，交给0环的VMM来处理，这个很大程度上与应用程序的系统调用很类似：系统调用的作用是把应用程序无权执行的指令交给操作系统完成。因此，Xen向Guest OS提供了一套“系统调用”。以方便Guest OS调用，这部分”系统调用“就是超级调用Hypercall。

**硬件辅助虚拟化技术 Hardware assisted virtualization**

![CPU硬件辅助虚拟化技术_技术_02](http://s2.51cto.com/wyfs02/M01/79/F3/wKiom1afGTSh8RorAABRoN9MaUU781.png?x-oss-process=image/format,webp/resize,m_fixed,w_1184)

+ 目前主要有Intel的VT-x和AMD的AMD-V这两种技术。

+ 提前配置好了Guest OS的哪些指令会触发root和非root的切换

  ![CPU硬件辅助虚拟化技术_计算机系统_04](http://s2.51cto.com/wyfs02/M00/79/F3/wKiom1afGaLTpUkXAAA7ZB52HHU125.png?x-oss-process=image/format,webp/resize,m_fixed,w_1184)

+ 其核心思想都是通过引入新的指令和运行模式，使VMM和Guest OS分别运行在不同模式（ROOT模式和非ROOT模式）下，且Guest OS运行在Ring 0下。通常情况下，Guest OS的核心指令可以直接下达到计算机系统硬件执行，而不需要经过VMM。当Guest OS执行到特殊指令的时候，系统会切换到VMM，让VMM来处理特殊指令。

+ 宿主机OS和VMM运行在root模式下，一旦虚拟机尝试执行敏感指令，CPU直接陷入root模式的VMM处理，这个过程就是VM-exit，而运行非敏感指令时触发非root级别，这个过程就是VM-entry

+ 不用像主动全虚拟化技术主动捕获全部的指令，然后识别处理，也不用半虚拟化技术那样子修改虚拟机OS的内核

2. 如何让多个VM共享CPU?

   

3. [x86架构和ARM架构](https://zhuanlan.zhihu.com/p/21266987)

   Intel和ARM处理器的第一个区别是，前者使用复杂指令集（CISC)，而后者使用精简指令集（RISC）

   X86无法做到ARM的功耗，而ARM也无法做到X86的性能。

   具体原因：自己看

4. CPU指令级别 Ring0~3 介绍

   RING设计的初衷是将系统权限与程序分离出来，使之能够让OS更好的管理当前系统资源，也使得系统更加稳定。举个RING权限的最简单的例子：<u>一个停止响应的应用程式，它运行在比RING0更低的指令环上，你不必大费周章的想着如何使系统回复运作，这期间，只需要启动任务管理器便能轻松终止它，因为它运行在比程式更低的RING0指令环中，拥有更高的权限，可以直接影响到RING0以上运行的程序</u>，当然有利就有弊，RING保证了系统稳定运行的同时，也产生了一些十分麻烦的问题。比如一些OS虚拟化技术，在处理RING指令环时便遇到了麻烦，系统是运行在RING0指令环上的，但是虚拟的OS毕竟也是一个系统，也需要与系统相匹配的权限。而RING0不允许出现多个OS同时运行在上面，最早的解决办法便是使用虚拟机，把OS当成一个程序来运行。

### 存储虚拟化

#### 云计算虚拟化中的存储架构

![img](https://img2020.cnblogs.com/blog/1953408/202103/1953408-20210313163336613-70959312.png)

#### 存储的分类

- 存储系统
  - 封闭系统存储（基于大型机）
  - 开放系统存储（基于Windows、Unix、Linux的服务器）
    - 内置存储
    - 外挂存储（按照连接方式分为以下几种，占市场大多数）
      - 直接式存储（Directed-Attached Storage：DAS）：采用SCSI接口，带宽限制，扩容需停机
      - 网络存储（Fabric-Attached Storage：FAS）：（依传输协议分）
        - 网络接入存储（Network-Attached Storage：NAS）：TCP/IP连接
        - 存储区域存储（Storage Area Network：SAN）：光纤连接

#### NAS

NAS的文件系统主要在存储侧，使用的网络协议主要是NFS和CIFS

- CIFS（Common Internet File System）通用网络文件系统：由微软Smb（Server Message Block）发展而来的一个公共、开放的文件系统
- NFS（Network File System）网络文件系统：在类Unix系统中实现网络文件共享

|              | **CIFS**               | **NFS**          |
| ------------ | ---------------------- | ---------------- |
| **传输特点** | 基于网络，可靠性要求高 | 独立于传输       |
| **易用性**   | 无需额外软件           | 需要安装专用软件 |
| **安全性**   | 无法进行错误恢复       | 可以进行错误恢复 |
| **文件转换** | 不保留文件格式特性     | 保留文件格式特性 |

#### SAN

| **描述**   | IP-SAN                               | FC-SAN                                                       |
| ---------- | ------------------------------------ | ------------------------------------------------------------ |
| 网络速度   | 1Gb、10Gb、40Gb                      | 4Gb、8Gb、16Gb                                               |
| 网络架构   | 使用现有IP网络                       | 单独建设光纤网络和HBA卡                                      |
| 传输距离   | 理论上没有距离限制                   | 受到光纤传输距离的限制                                       |
| 管理、维护 | 与IP设备一样操作简单                 | 技术和管理较复杂                                             |
| 兼容性     | 与所有IP网络设备都兼容               | 兼容性差                                                     |
| 性能       | 目前主流1Gb，10Gb正在发展            | 非常高的传输和读写性能                                       |
| 成本       | 购买与维护成本都较低                 | 购买（光纤交换机、HBA卡、光纤磁盘阵列等）与维护（培训人员、系统设置与监测等）成本高 |
| 容灾       | 本身可以实现本地和异地容灾，且成本低 | 容灾的硬件、软件成本高                                       |
| 安全性     | 较低                                 | 较高                                                         |

- IP-SAN：顾名思义，以TCP/IP协议作为底层传输协议，用以太网作为承载介质构建区域网络架构。实现IP-SAN的典型协议是iSCSI，它定义了SCSI指令集在IP中传输的封装方式
- FC-SAN：采用Fibre Channel Protocol（光纤通道协议），服务器与存储设备间通过光纤交换机直接建立连接

#### 传统内置存储遇到的问题

- 硬盘成为整个系统的性能瓶颈
  - 槽位有限，难满足大容量需求
  - 单硬盘存储数据，可靠性不高
- 存储空间利用率低
  - 本地存储，数据分散，不易共享
- 可扩展性不高
  - 总线结构，而非网络结构
  - 可连接的设备受到限制
  - 扩容的时候需要停机

#### 优劣比较

|          | DAS                                    | NAS                      | FC-SAN                         | IP-SAN         |
| -------- | -------------------------------------- | ------------------------ | ------------------------------ | -------------- |
| 传输类型 | SCSI、FC                               | IP                       | FC                             | IP             |
| 数据类型 | 块级                                   | 文件级                   | 块级                           | 块级           |
| 典型应用 | 任何                                   | 文件服务器               | 数据库应用                     | 视频监控       |
| 优点     | 易于理解兼容性好                       | 易于安装成本低           | 高扩展性高性能高可用性         | 高扩展性成本低 |
| 缺点     | 难以管理，扩展性有限存储空间利用率不高 | 性能较低对某些应用不适合 | 比较昂贵，配置复杂互操作性问题 | 性能较低       |

#### 虚拟化中的存储架构

![img](https://img2020.cnblogs.com/blog/1953408/202103/1953408-20210313165328129-761921081.png)

虚拟化的数据存储是将存储资源按照一定的文件系统来管理

- 虚拟化的数据存储包括
  - 虚拟化本地硬盘（采用EXT4文件系统）
  - 虚拟化SAN存储（使用VIMS虚拟镜像管理文件系统）
  - NAS存储（使用NFS网络文件系统）

实质为块存储，包括SAN存储，本地磁盘和FusionStorage

可以简单理解为：块存储 + 文件系统 = 虚拟化存储

举个例子：SAN存储（划分逻辑卷）+ 文件系统 = 虚拟化存储

#### 常见的虚拟机磁盘格式

虚拟机磁盘以文件的形式存放于文件系统之中，常见的虚拟机磁盘格式有以下几种

| **虚拟机磁盘文件格式** | **支持的厂商**                 |
| ---------------------- | ------------------------------ |
| RAW                    | 各厂商通用                     |
| VMDK                   | VMware                         |
| VHD                    | 微软Hyper-V、华为FusionCompute |
| QCOW                   | QEMU或KVM虚拟化平台专用的格式  |
| QED                    | QEMU或KVM虚拟化平台专用的格式  |
| VDI                    | Oracle                         |

##### VHD

VHD（Virtual Hard Disk）是微软推出的一种虚拟机磁盘文件格式，VHD就是虚拟机磁盘文件。

VHD文件内容主要是虚拟机启动所需的系统文件，可被压缩成单个文件存放在系统上。

一个VHD文件代表VIMS（虚拟镜像管理系统）在虚拟机上的一个物理硬盘驱动，所有用户数据以及有关虚拟服务器的配置都存储在VHD文件中。

VHD虚拟硬盘的四种类型：

- 固定VHD：对已分配大小不会更改
- 动态VHD：大小与写入的数据大小相同，随着数据写入直至达到大小上限（2040GB）
- 差异VHD：类似动态VHD，但只包含关联父VHD修改后的硬盘快（最大2040GB）
- 链接硬盘VHD：文件本身指向一个磁盘或者一个分区

##### VMDK

VMDK（VMWareVirtual Machine Disk Format）VMware创建的虚拟硬盘格式，文件存放在VMware文件系统中，被称为VMFS（虚拟机文件系统）。

一个VMDK文件代表VMFS在虚拟机上的一个物理硬盘驱动。所有用户数据和有关虚拟服务器的配置信息都存储在VMDK文件中。

厚磁盘（Thick Disk）：属于VMFS，创建VMDK文件时分配所有需要的空间

薄磁盘（Thin Disk）：属于VMFS，创建VMDK时分配较小的空间，当写入数据增加时，动态增加存储空间

##### Raw

原始磁盘（Raw Disk）

VM的OS直接访问存储设备上的LUN，不属于VMFS。

不能用VADP来备份，在VM中安装备份代理来备份。

#### 物理磁盘

##### 硬盘类型

| 硬盘类型 | 转速                 | 一般容量          | 性能   |
| -------- | -------------------- | ----------------- | ------ |
| SATA     | 5400 rpm 或 7200 rpm | 1~4TB             | 普通   |
| NL-SAS   | 7200 rpm             | 300GB/450GB/600GB | 好     |
| SAS      | 10k rpm 或 15k rpm   | 300GB/450GB/600GB | 好     |
| SSD      | 闪存读写             | 256GB/512GB       | 非常好 |

##### 机械硬盘的结构

![img](https://img2020.cnblogs.com/blog/1953408/202103/1953408-20210314140508365-175055110.png)

- 硬盘的组成架构
  - 磁头组件
    - 用于数据的读取和写入。
  - 磁头驱动机构
    - 用于驱动磁头臂将磁头送达指定的位置。
  - 盘片组
    - 数据的载体。
  - 主轴驱动装置
    - 驱动盘片维持高速运转。
  - 控制电路
    - 系统控制、调速、驱动等。

![img](https://img2020.cnblogs.com/blog/1953408/202103/1953408-20210314211648306-916706158.png)

- 盘片的逻辑结构
  - 磁道
    - 盘片上围绕着主轴的同心环，数据被记录在磁道上
    - 从盘片的外边缘开始向内编号
    - 磁道密度 TPI：盘片上每英寸的磁道数
  - 扇区
    - 每个磁道被分成更小的单位，叫做扇区
    - 扇区是磁盘中可以单独寻址的最小存储单元
    - 通常情况下，一个扇区可以保存512Bytes数据，但有一些磁盘可以被格式化为更大的扇区大小，如4KB扇区
  - 柱面
    - 在同一个磁盘中所有盘片，具有相同编号的磁道形成一个圆柱，称之为磁盘的柱面
    - 柱面数 = 一个盘面上的磁道数
    - 磁盘中，磁头的位置由柱面号来说明，而非磁道号
  - C/H/S（Cylinder/Head/Sector）
    - 寻址模式，柱面 - 磁头 - 扇区

![img](https://img2020.cnblogs.com/blog/1953408/202103/1953408-20210314143211372-615356409.png)

- 硬盘主要参数
  - 硬盘容量（Volume）
    - 容量单位为兆字节MB或千兆字节GB
    - 影响硬盘容量的因素有单碟容量和碟片数量
  - 转速（Rotational speed）
    - 硬盘盘片每分钟转过的圈数
    - 单位 RPM（Rotation Per Minute）
  - 缓存（Cache）
    - CPU与硬盘之间存在巨大的速度差异，为了解决硬盘在读写数据时CPU的等待问题，在硬盘上设置适当的高速缓存，用以解决两者速度不匹配的问题
    - 硬盘缓存与CPU上的高速缓存一样，是为了提高硬盘的读写速度

![img](https://img2020.cnblogs.com/blog/1953408/202103/1953408-20210314143400523-686131907.png)

- 平均访问时间 --- 衡量硬盘性能的指标

  - 平均访问时间由以下两项构成
    - 平均寻道时间（Average Seek Time）
    - 平均等待时间（Average Latency Time）
    - 平均访问时间 = 平均寻道时间 + 平均等待时间

  > 平均寻道时间：磁头从初始位置移动到盘面指定磁道所需的时间
  >
  > 硬盘等待时间：磁头已处于要访问的磁道，等待所要访问的扇区旋转至磁头下方的时间
  >
  > 平均等待时间通常为盘片旋转一周所需时间的一半，因此磁盘转速越快，等待的时间就越短

#### 硬盘常用接口

| 接口                                                      | 优点                                 | 缺点             |
| --------------------------------------------------------- | ------------------------------------ | ---------------- |
| ATA（Advanced Technology Attachment）高级技术附加装置     | 便宜、兼容性好                       | 慢、只能内置使用 |
| SATA（Serial ATA）串行ATA                                 | 点对点连接，支持热插拔、即插即用     | 中规中矩         |
| SCSI（Small Computer System Interface）小型计算机系统接口 | 性能高、具有内置外置两种，支持热插拔 | 贵、难装         |
| M.2（NVMe协议走PCI-E通道）                                | 超级快                               | 巨贵             |

#### 热插拔

- 优点

  - 允许用户在不关闭系统、不切断电源的情况下取出和更换损坏的硬盘、电源或板卡等部件
  - 提高了系统对灾难的及时恢复能力、扩展性和灵活性等

  热插拔也可以叫热替换、热添加和热升级

#### 固态硬盘概述

- SSD性能优势
  - 响应时间短
    - SSD内部没有机械运动部件，省去了寻道时间和机械延迟
  - 读写效率高
    - 机械硬盘进行随机读写的时候，由于磁头不停移动，导致读写效率低下
    - SSD通过内部控制器计算数据存放位置，省去机械操作时间，提高IOPS
    - 4K随机读写情况下SSD硬盘性能远胜于FC硬盘
- SSD原理
  - 使用闪存技术存储信息
  - 内部没有机械结构，因此耗电量小、散热小、噪音小

| **类型**    | **容量** | **可擦写次数** | **单位容量价格** |
| ----------- | -------- | -------------- | ---------------- |
| SLC         | 小       | 约100,000      | 高               |
| eMLC 企业   | 中等     | 约30,000       | 中等             |
| cMLC 消费者 | 中等     | 5,000 ~10,000  | 低               |
| TLC         | 大       | 500 ~ 1,000    | 很低             |

（对SSD盘可靠性影响最大的是其抗磨损能力，即Cell的可擦写次数。）

- SSD的3种主要类型
  - SLC (Single Level Cell)，单层式存储单元
    - 一个存储单元（Cell）中只存1bit数据：0或1
  - MLC (Multi Level Cell)，多层式存储单元
    - 一个存储单元（Cell）中只存2bit数据：00,01,10,11
  - TLC (Triple Level Cell)，三层式存储单元
    - 一个存储单元（Cell）中只存3bit数据：000,001,010,011,100,101,110,111

#### 集中式存储和分布式存储

| 类型       | 部署模式                                                     | 优点                       | 缺点                                         |
| ---------- | ------------------------------------------------------------ | -------------------------- | -------------------------------------------- |
| 集中式存储 | 一台或多台计算机组成中心节点，数据几种存储于中心节点，并且所有业务单元都几种部署在这个中心节点中，终端只负责录入和输出 | 部署简单、底层主机性能卓越 | 缺乏异地容灾能力                             |
| 分布式存储 | 组件分布在网络计算机上，组件之间仅仅通过消息传递来通信并协调行动 | 分布式、并发性             | 缺乏全局时钟、存在单点故障、单机能力存在瓶颈 |

#### 什么是RAID？

RAID：独立磁盘冗余阵列（Redundant Array of Independent Disks），一种把多块独立的物理硬盘按不同方式组合起来，形成一个硬盘组（逻辑硬盘），从而提供比单个硬盘更好的存储性能和数据备份技术

#### 使用RAID的好处

- 提供硬盘串接，将所有硬盘组组成一个虚拟的大盘
- 将资料切割成多个区块，以并行的方式进行读写，当硬盘越多的时候，读写的速度越快
- 镜像校验/异或校验，提供硬盘容错功能

#### 常用RAID类型

![img](https://img2020.cnblogs.com/blog/1953408/202103/1953408-20210316174134594-1029758652.png)

| RAID级别     | RAID 0                                   | RAID 1                                               | RAID 5                                             | RAID 10                                    |
| ------------ | ---------------------------------------- | ---------------------------------------------------- | -------------------------------------------------- | ------------------------------------------ |
| 容错性       | 无                                       | 有                                                   | 有                                                 | 有                                         |
| 冗余类型     | 无                                       | 复制                                                 | 奇偶校验                                           | 复制                                       |
| 热备盘选项   | 无                                       | 有                                                   | 有                                                 | 有                                         |
| 读性能       | 高                                       | 低                                                   | 高                                                 | 一般                                       |
| 随机写性能   | 高                                       | 低                                                   | 低                                                 | 一般                                       |
| 连续写性能   | 高                                       | 低                                                   | 低                                                 | 一般                                       |
| 最小硬盘数   | 2块                                      | 2块                                                  | 3块                                                | 4块                                        |
| 可用容量     | N * 单块硬盘容量                         | 单块硬盘容量                                         | (N -1) * 单块硬盘容量                              | (N /2) * 单块硬盘容量                      |
| 典型应用环境 | 迅速读写，安全性要求不高，如图形工作站等 | 随机数据写入，安全性要求高，如服务器、数据库存储领域 | 随机数据传输，安全性要求高，如金融、数据库、存储等 | 数据量大，安全性要求高，如银行、金融等领域 |

#### RAID的数据组织方式

![img](https://img2020.cnblogs.com/blog/1953408/202103/1953408-20210317182902303-2078330041.png)

- 条带：磁盘中单个或者多个连续的扇区构成一个条带。它是组成分条的元素。
- 分条：同一磁盘阵列中的多个磁盘驱动器上的相同“位置”（或者说是相同编号）的条带
  - 分条宽度：指在一个分条中数据成员盘的个数（上图分条宽度为3）
  - 分条深度：指一个条带的容量大小（根据硬盘大小而定）

#### RAID校验方式（异或校验）

![img](https://img2020.cnblogs.com/blog/1953408/202103/1953408-20210327111016994-231351381.png)

- XOR校验的算法 —— 相同为假，相异为真

  - 0⊕0= 0； 0⊕1= 1； 1⊕0= 1； 1⊕1= 0；

- XOR的逆运算仍为XOR

  - 如果A为1，B为0，则校验值P为1：A(1)⊕B(0)= P(1)
  - 则有逆运算：B(0)⊕P(1)=A(1)；A(1)⊕P(1)=B(0)

  按照上面的异或校验的方法，无论如和都可以计算出原盘的数据值（假设损坏一块）

#### RAID与LUN的关系

![img](https://img2020.cnblogs.com/blog/1953408/202103/1953408-20210316185832601-391760179.png)

- RAID由几个硬盘组成，从整体上看相当于由多个硬盘组成的一个大的物理卷

- LUN（Logical Unit Number）逻辑单元号：用来标识一个逻辑单元的数字，这个逻辑单元是通过SCSI寻址的设备。换言之，存储系统将物理硬盘进行分区，成为拥有逻辑地址的各个部分，进而允许主机进行访问，这样的一个分区便称为一个LUN。通常说的LUN也指在SAN存储上创建逻辑磁盘。

  关于LUN：https://support.huawei.com/enterprise/zh/doc/EDOC1100096895/

#### 创建LUN的过程

![img](https://img2020.cnblogs.com/blog/1953408/202103/1953408-20210318233833042-1330495064.png)

1. 物理硬盘划分成物理卷
2. 物理卷逻辑划分成逻辑卷提供LUN

#### Pool & Volume & LUN

![img](https://img2020.cnblogs.com/blog/1953408/202103/1953408-20210319001141556-145429101.png)

- Pool即存储池，是存放存储空间资源的容器，所有应用服务器使用的资源来自于存储池里面
- Volume即卷，是存储系统内部管理对象
- LUN是可以直接映射给主机读写的存储单元，是Volume对象的对外体现

> 数据作为文件存储在操作系统可见的卷上。
>
> Windows操作系统，用驱动器号（例如C盘、F盘）来表示使用的卷。
>
> Unix/Linux操作系统，则是挂载点。
>
> 驱动号（或挂载点）和物理硬盘之间的关系如下：
>
> 1. 物理硬盘组合形成一个RAID组
> 2. RAID组有一个与其相关联的特定的RAID类型
> 3. LUN由一个RAID组的（一段）存储容量构成，LUN映射给主机，成为操作系统可以使用的存储空间

#### 虚拟化存储和非虚拟化存储

![img](https://img2020.cnblogs.com/blog/1953408/202103/1953408-20210321114728987-363477983.png)

这里的存储虚拟化是狭义的虚拟化，仅指集群是否有文件系统。

有无文件系统？有，即为虚拟化存储；没有，即为非虚拟化系统。

这里的文件系统可以是NFS文件系统，也可以是虚拟化集群的文件系统。

如果是没有文件系统，虚拟化集群需要直接调动逻辑卷使用。

无论是集中式存储还是分布式存储，使用RAID或者副本机制之后，都会形成一个物理卷，但是大多数情况下都不会把整个物理卷挂载给上层的应用（操作系统或者虚拟化系统，这里单指虚拟化系统）使用。因为如果把整个物理卷全部挂载后，所有的空间都会被上层应用拿去格式化，一旦存储空间使用完了，虽然可以通过添加硬盘的方式进行扩容，但是扩容后需要重新格式化，数据可能会丢失，所以，一般会将物理卷组成卷组，然后再将卷组划分成多个逻辑卷，而上层应用使用的是逻辑卷的空间。

在云计算中，虚拟化程序会将逻辑卷格式化，各个厂商的虚拟化文件系统不相同，例如：

VMware——VMFS（Virtual Machine File System）

华为——VIMS（Virtual Image Manage System）

它们都属于高性能的集群文件系统，可以使虚拟化超出单个系统的限制，使得多个计算节点同时访问一个整合后的集群式存储池。这种计算集群的文件系统可以保证没有哪一台服务器或者某个应用软件可以完全控制对文件系统的访问。

以华为的VIMS为例子，它是基于SAN存储，因此FusionStorage提供存储空间时，只能是非虚拟化存储，通过VIMS，FusionCompute以文件形式管理虚拟机镜像及配置文件。VIMS使用分布式锁机制确保集群中的数据读写的一致性。虚拟化程序使用的最小存储单位为LUN，而和LUN对应的是卷，卷是存储系统内部管理的对象，LUN Volume对象的对外体现。LUN和卷都是从一个资源池（Pool）中划分出来的。

#### 云计算中虚拟化存储转换路径

1. 存储资源（Raid或者副本机制）→ 物理卷格式化（物理卷无法直接给主机使用，需要格式化）→ 主机

2. 存储资源 → 物理卷逻辑划分 → 逻辑卷 （可直接挂载给主机用） → 格式化后生成NFS文件系统

   或者逻辑卷（格式化挂在给集群）→ 生成虚拟文件系统 → 主机（看到的是一个共享目录）

   举例：

#### 云计算中非虚拟化存储转换路径

1. 存储资源（Raid或者副本机制）→ 物理卷（逻辑划分）→ 逻辑卷（不用格式化）→ 集群（直接挂载）

   → 虚拟硬盘（无文件系统）

   这个文件系统需要由上层操作系统来格式化

   举例：Windows系统下新添加的一块硬盘，需要从物理卷逻辑划分出逻辑卷，然后由操作系统格式化文件系统以供用户使用。

#### 文件系统

![img](https://img2020.cnblogs.com/blog/1953408/202103/1953408-20210321122945137-1241723351.png)

文件系统：是指把文件存储于硬盘时所必须的数据结构及硬盘数据的管理方式。

- 为了访问硬盘中的数据，就必须在扇区之间建立联系，也就是需要一种逻辑上的数据存储结构。建立这种逻辑结构就是文件系统需要做的事情，在硬盘上建立文件系统的过程通常称之为“格式化”。
- 硬盘数据的管理通过文件分区表，记录数据的地址，然后通过地址记录实现对数据的读取。

文件系统的功能：

1. 管理空间：管理和调度文件的存储空间
2. 存储方法：提供文件的逻辑结构、物理结构和存储方法
3. 文件名映射：实现文件从标识到实际地址的映射
4. 文件操作：实现文件的控制和存取操作（包括文件的建立、撤销、开关、读写等）
5. 文件共享：实现文件信息的共享并提供可靠的文件保密和保护措施、提供文件的安全措施（文件的转储和恢复能力）

##### 常见的文件系统

![img](https://img2020.cnblogs.com/blog/1953408/202103/1953408-20210321124041115-509876106.png)

##### 文件映射到磁盘的过程

![img](https://img2020.cnblogs.com/blog/1953408/202103/1953408-20210321124022574-1312171579.png)

1. 用户或应用程序创建文件或文件夹；
2. 被创建的文件和文件夹被保存在文件系统上；
3. 文件系统会将这些文件对应的数据映射到文件系统块上；
4. 文件系统块和逻辑卷形成的逻辑区域进行对应；
5. 通过操作系统或者LVM将逻辑区域映射到物理磁盘的物理区域，也就是逻辑卷和物理卷的对应；
6. 最后，物理区域对应的一个物理卷里会包含一个或多个物理磁盘

##### 主机的内部应用环境

![img](https://img2020.cnblogs.com/blog/1953408/202103/1953408-20210321234806782-1450504936.png)

主机内部I/O流程各个环节共同构成了数据存储的内部应用环境

- 主机服务器大部分I/O开始于需要访问数据的应用
- 而应用通常不考虑存储后端的操作细节，而是直接调用由操作系统提供的系统调用接口。
- 然后由操作系统支持的文件系统为数据提供数据的逻辑地址和在磁盘上存储的物理地址的映射
- 再通过设备驱动层，主要是由SCSI协议的操作，将数据存储到存储设备上

#### 虚拟机磁盘介绍

##### 虚拟磁盘

![img](https://img2020.cnblogs.com/blog/1953408/202103/1953408-20210321235608119-1815838473.png)

虚拟机磁盘是文件系统上的一个文件，对于Guest OS而言，就像是一个物理磁盘驱动器。

这个文件既可以在主机上，也可以在远端文件系统上。

在给虚拟机配置虚拟磁盘后，可以将新的操作系统安装到该磁盘文件上。

#### 常见的虚拟机磁盘格式

| **虚拟机磁盘文件格式** | **支持的厂商**                 |
| ---------------------- | ------------------------------ |
| RAW                    | 各厂商通用                     |
| VMDK                   | VMware                         |
| VHD                    | 微软Hyper-V、华为FusionCompute |
| QCOW                   | QEMU或KVM虚拟化平台专用的格式  |
| QED                    | QEMU或KVM虚拟化平台专用的格式  |
| VDI                    | Oracle                         |

#### 华为虚拟化产品的存储特性

##### 华为虚拟化产品存储架构

- 数据存储：裸设备映射、虚拟化存储
- 存储设备：LUN、共享目录
- 存储资源：FusionStorage Block、SAN、NAS

##### 存储资源

- FusionSphere的存储资源包括：IP SAN、FC SAN 、Advanced SAN、本地磁盘、FusionStorage、NAS
  - IP SAN通过iscsi链路和主机建立连接
  - FC SAN通过光纤通道和主机连接，主机连接SAN设备后可以扫描存储设备（LUN）
  - Advanced SAN通过SMI-S接口扫描、管理磁盘的
  - FusionStorage通过其管理节点FSM提供的接口来管理存储
  - NAS通过NFS协议扫描和挂载共享目录
- 主机访问存储资源
  - 先需要添加存储资源
  - 再选定主机并关联存储资源

##### 存储设备

- FusionCompute的存储设备有五种：LUN、本地磁盘、Advanced SAN存储池、FusionStorage存储池、NAS共享目录
- 存储设备需要通过主机探测的方式进行扫描来发现
  - 主机需要连接存储资源后才能扫描存储资源所包含的存储设备
  - 每个主机都能发现各自的存储设备，也能发现共享的存储设备
- 存储设备可以被指定给特定的主机或者计算集群

##### 数据存储

- 数据存储是在存储设备上创建的逻辑管理单元
  - 数据存储需要创建在指定的存储设备上，且一个存储设备只能创建一个数据存储
  - 也可以接入某一个数据存储
  - 数据存储和主机关联，为主机提供资源
  - 数据存储可以关联到多个主机
  - 一个主机也可以使用多个数据存储
- 数据存储的使用
  - 存储设备必须被添加为数据存储才能被使用
  - 数据存储可用于存放虚拟机磁盘、快照文件
  - 数据存储的大小依赖于存储设备的大小
- 计算集群有共享存储设备时，基于该存储设备建立的数据存储被关联给集群中的每一个主机
- 数据存储需要创建在指定的存储设备上，但一个数据存储可以有多个存储设备

##### 添加数据存储

- 使用方式：
  - 虚拟化：虚拟化的数据存储创建普通磁盘速度较慢，但是可以支持部分高级特性；如果创建精简磁盘，还可以支持更多高级特性，能提高存储资源的利用率和系统的安全性、可靠性。
  - 非虚拟化：非虚拟化的数据存储创建速度较快，性能优于虚拟化存储，除FusionStorage、Advanced SAN、本地内存盘外，其余无法支持磁盘的高级特性。
  - 裸设备映射：裸设备映射是将SAN存储的物理LUN直接作为磁盘绑定给虚拟机，使SAN存储具有更高的性能，且支持SCSI协议。该类型的数据只能整块当作裸设备映射的磁盘使用，不可分割，因此只能创建与数据存储同等容量的磁盘，且不支持虚拟化存储的高级特性。

##### 虚拟化存储的高级特性（需拓展）

- 快照
- 精简磁盘
- 链接克隆
- 磁盘扩容
- 存储热迁移

#### 华为虚拟磁盘特性

![img](https://img2020.cnblogs.com/blog/1953408/202103/1953408-20210323222435230-881515814.png)

#### 类型

添加完数据存储之后，就可以为虚拟机创建虚拟磁盘了。在实际使用场景中，可能是多人共享一个虚拟机磁盘，也可能需要节省更多的物理空间等。按照类型，可以将虚拟机磁盘分为普通和共享两个。

> - 类型
>   - 普通：普通磁盘只能单个虚拟机使用。
>   - 共享：共享磁盘可以绑定给多个虚拟机使用。

多台虚拟机使用同一个共享磁盘时，如果同时写入数据，有可能会导致数据丢失。

若使用共享磁盘，需要应用软件保证对磁盘的访问控制。

#### 磁盘模式

根据磁盘模式，可以将虚拟机磁盘划分为从属、独立-持久和独立-非持久

> - 磁盘模式
>   - 从属：快照中包含该从属磁盘，更改将立即并永久写入磁盘。
>   - 独立-持久：更改将立即并永久写入磁盘，持久磁盘不受快照影响。
>   - 独立-非持久：关闭电源或恢复快照后，丢弃对该磁盘的更改。

若选择”独立-持久“或”独立-非持久“，则对虚拟机创建快照时，不对该磁盘的数据进行快照。

使用快照还原虚拟机时，不对该磁盘的数据进行还原。

如果快照后，该磁盘被解绑定且未绑定其它虚拟机，则快照恢复的虚拟机会重新绑定该磁盘，但磁盘数据不进行还原。

如果快照后，该磁盘被删除，则快照恢复的虚拟机上不存在该磁盘。

有些磁盘的类型一旦设定了就不可以更改，有些还可以更改，比如磁盘模式之间是可以相互转换的。

#### 配置模式

| 配置模式     | 说明             | 例解                                                         |
| ------------ | ---------------- | ------------------------------------------------------------ |
| 普通         | 性能高，速度慢   | 给某个虚拟机分配50G的普通磁盘，则此虚拟机立刻占用50G的空间，并将这50G对应的物理设备上保留的数据置零。 |
| 精简         | 性能一般，速度快 | 给某个虚拟机分配50G的精简磁盘，则此虚拟机初始仅占用部分空间，并仅将这部分对应的物理设备上保留的数据置零，后续根据使用情况，逐步进行分配，直到分配总量达到50G为止。 |
| 普通延迟置零 | 性能与速度适中   | 给某个虚拟机分配50G的普通延迟磁盘，则此虚拟机立刻占用50G的空间，但不会擦除物理设备上保留的任何数据，后续根据使用情况，逐步进行置零，直到总量达到50G为止。 |

> - 配置模式
>   - 普通：立即分配空间，并置零
>   - 精简：分配部分空间（置零这部分空间），之后逐渐分配至上限。
>   - 普通延迟置零：立即分配空间，不置零，首次执行写操作时按需置零。

建议系统盘使用**普通磁盘**配置模式，性能较高

使用**精简磁盘**可能会导致数据存储超分配，建议超分配比例不超过50%。

超分配率可以通过数据存储的概要页面”已分配容量“和”总容量“的比率关系来确定。

数据存储类型为“FusionStorage”或“本地内存盘”时，只支持**精简磁盘**模式；

### 网络虚拟化

#### 传统DC与云DC的区别

- 传统数据中心的特点：
  - 一个物理网口对应一台计算机
  - 计算机与网络关系固定，很少变动
- 云计算数据中心的变化：
  - 一个物理网口对应若干虚拟机
  - 虚拟机与网络关系不定，会频繁的进行跨主机迁移
  - 传统南北向流量为主的数据中心架构不再满足未来发展
  - 热迁移使得计算能力不再固定在具体的物理位置

#### 流量走向

- 南北向流量：指数据中心外部用户和内部服务器之间交互的流量
- 东西向流量：指数据中心内部服务器之间交互的流量

#### 网络虚拟化

##### 网络模式

**NAT模式**

![img](https://img2020.cnblogs.com/blog/1953408/202103/1953408-20210328175507740-364119647.png)

原理：做两次NAT转换，第一次在虚拟交换机，第二次在路由器，访问外部网络。

**桥接模式**

![img](https://img2020.cnblogs.com/blog/1953408/202103/1953408-20210328175519469-877447045.png)

原理：可以看作在局域网中创建了一台独立的主机

##### Linux Bridge（网桥）

![img](https://img2020.cnblogs.com/blog/1953408/202103/1953408-20210328162451007-1367491554.png)

- 原理
  - Linux Bridge（网桥），工作于二层的虚拟网络设备，类似交换机
  - 网桥可以绑定其他的Linux设备作为从设备，并将接入设备虚拟化为端口，当设备被绑定到Bridge上时，就相当于往真实网络中的交换机端口上插入了一个网线

> Bridge设备br0绑定了实际设备eth0与虚拟设备tap0/tap1,此时，对于Hypervisor的网络协议栈上层来说，只看得到br0，并不会关心网桥的细节，当这些从设备接收到数据包时，会将其提交给br0决定数据包的去向，br0会根据MAC地址与端口的映射关系进行转发。

#### OVS（虚拟交换机）

![img](https://img2020.cnblogs.com/blog/1953408/202103/1953408-20210328170941753-2068211372.png)

![img](https://img2020.cnblogs.com/blog/1953408/202103/1953408-20210328155114194-147328709.png)

- Open vSwitch（OVS）是一款基于软件实现的开源虚拟以太网交换机
- OVS能够支持多种标准的管理接口和协议，还可以支持跨多个物理服务器的分布式环境
- OVS提供了对OpenFlow协议的支持，并且能够与众多开源的虚拟化平台相整合
- 两个主要作用：传递虚拟机之间的流量、实现虚拟机与外部网络的通信

#### EVS（弹性虚拟交换机）

![img](https://img2020.cnblogs.com/blog/1953408/202103/1953408-20210328171116967-1257909845.png)

- EVS（Elastic Virtual Switch，弹性虚拟交换机），华为改进版OVS
- 基于OVS转发技术，提升了其IO性能的一种弹性虚拟交换
- EVS关键技术：
  - 物理网卡访问：DPDK高速数据通道
  - 报文处理：使用大页内存
  - 交换业务处理
    - 轮询转发，减少调度开销
    - 多核（线程）并行处理
    - Openflow流表转发优化
  - 前后端：vhost-user技术

#### DVS（分布式虚拟交换机）

![img](https://img2020.cnblogs.com/blog/1953408/202103/1953408-20210328171205725-1114142621.png)

- 主要组件
  - DVSA
  - DVSM
  - 通过DVSA-OVS(API)-OVS管理
- 作用
  - 分布式虚拟交换机在所有关联主机间作为单个虚拟交换机使用
  - 分布式虚拟交换机一端是与虚拟机相连的虚拟接口，另一端是虚拟机所在主机上的物理以太网连接的上行链路
  - 分布式虚拟交换机是关联多台主机的虚拟交换机，可以保证虚拟机在主机之间进行迁移时保持一致的网络配置。

#### OVS、EVS、DVS的区别

- OVS：单节点的虚拟交换机，服务器内部的虚拟交换，VM与外部的通信
  - 不足：1.单线程 2.内核态
- EVS：华为增强版本vSwitch，单节点的虚拟交换机，服务器内部的虚拟交换，VM与外部的通信
  - 改进：1.多线程 2.用户态
- DVS：分布式虚拟交换机，由VRM（DVSM）逻辑将各个CNA节点上的EVS（OVS）组合成DVS
  - DVS的组成
    - 端口：连接虚拟机
    - 端口组：一组属性（VLAN，QoS等）相同的端口，不同端口组可有相同VLAN
    - 上行链路：在创建DVS的时候，流量出服务器，通过上行链路，将DVS与网口绑定，独占该网口

#### FusionCompute网络架构

##### 架构图

![img](https://img2020.cnblogs.com/blog/1953408/202103/1953408-20210328162951786-1250574782.png)

- 虚拟网卡：虚拟网卡就是用软件来模拟网络环境，提供类似真实网卡的功能。
- 虚拟交换端口：虚拟交换机上的端口，用来连接虚拟网卡，为虚拟机提供接入网络的服务。
- 端口组：为了方便管理，将具有同样属性的一组虚拟交换端口成为端口组。
- 上行链路：上接虚拟交换机，下接物理网卡，打通虚拟机与外部的网络。
- 虚拟交换机OVS ：上接虚拟网卡，下接上行链路。
- 物理网卡：与物理交换机连接，使虚拟机发出的数据能够转发到物理网络。
- 分布式虚拟交换机DVS：在所有关联主机间作为单个虚拟交换机使用。

#### 华为分布式交换方案

![img](https://img2020.cnblogs.com/blog/1953408/202103/1953408-20210328171645805-1412011393.png)

- 特点：
  - 集中管理，简化用户的管理和配置
  - 开源Open vSwitch
  - 丰富的虚拟交换二层特性，包括交换、QoS、安全隔离等。
- 华为的分布式虚拟交换支持基于开源Open vSwitch的纯软件的虚拟交换的功能，同时提供支持完整虚拟交换卸载的智能网卡的虚拟交换。
- 开源Open vSwitch与智能网卡的虚拟交换提供的功能完全一致，虚拟交换管理通过不同的插件管理Open vSwitch和智能网卡。

#### 端口组

- 作用
  - 端口组是分布式虚拟交换机(DVS)中虚拟端口的集合。
  - 端口组主要是为了方便用户同时对端口组中的多个端口进行配置，以减少重复配置工作。
  - 连接在同一端口组的虚拟机网卡，具有相同的网络属性。
    如：带宽限速、优先级、VLAN、DHCP隔离、IP和MAC绑定等。
- 端口组可设置属性
  - 端口类型
    - 普通（Access）
    - 中继（Trunk）
  - VLAN
  - 流量整形
    - 发送流量整形
    - 接受流量整形
  - 广播抑制
    - ARP广播抑制
    - IP广播抑制
  - 安全属性
    - DHCP隔离
    - IP和MAC绑定
- 注意事项
  - 虚拟交换端口的属性包含速率、VLAN ID 和QoS等
  - 多个端口组可同属于一个分布式交换机DVS
  - 端口组不可以跨分布式交换机

#### 上行链路

![img](https://img2020.cnblogs.com/blog/1953408/202103/1953408-20210328164625941-1983857586.png)

- 作用
  - 上行链路是虚拟交换机的一部分，通过与CNA主机的物理网卡关联来连接物理网络
- 上行链路聚合
  - 分布式交换机关联的服务器绑定网口，绑定网口可以包含多个物理网口，这些物理网口可以配置主备或负载均衡策略。
- 注意事项
  - 同主机，不同DVS，不能共用上行链路
  - 与上行链路关联的物理网卡可以是单独的一个网口，也可以是多个网卡绑定后的一个逻辑通道
  - 同一台DVS的所有上行链路组成了上行链路组

#### 安全组

![img](https://img2020.cnblogs.com/blog/1953408/202103/1953408-20210328165813729-1413836699.png)

安全组：流量过滤规则

#### 虚拟交换机管理

![img](https://img2020.cnblogs.com/blog/1953408/202103/1953408-20210328165422780-2110534927.png)

VSP：虚拟交换端口

vNIC：虚拟网络接口

#### 虚拟网络流量走向

![img](https://img2020.cnblogs.com/blog/1953408/202103/1953408-20210328160646395-2123193695.png)

- 分布式交换机的交换网络中
  - 相同端口组，不同主机内，走物理网络
  - 相同端口组，相同主机内，不走物理网络
  - 不同端口组，无论是否相同主机，都需要走物理网络

#### 网络虚拟化特性

##### 华为虚拟交换模式

![img](https://img2020.cnblogs.com/blog/1953408/202103/1953408-20210328172943070-2000881104.png)

华为虚拟交换机提供三种虚拟交换模式：普通模式、SR-IOV直通模式、用户态交换模式

- 普通交换：普通模式下，虚拟机有前后端两个虚拟网卡设备，其中，前端网卡连接在虚拟交换机的虚端口上。虚拟机网络数据包通过环形缓冲区和事件通道在前后端网卡之间传输，并最终通过后端网卡连接的虚拟交换机实现转发。
- SR-IOV：一个网卡虚拟化成多个网卡供虚拟机使用
- 用户态交换：通过使用DPDK（Data Plane Development Kit，数据平面开发套件，DPDK是一系列库和驱动的集合）技术，用来在x86平台进行快速的数据包处理。它通过环境抽象层旁路内核协议栈、轮询模式的报文无中断收发、优化内存/缓冲区/队列管理、基于网卡多队列和流识别的负载均衡等多项技术，实现了在x86处理器架构下的高性能报文转发能力，提高虚拟机网络性能。

##### 网络安全策略

##### 二层网络安全策略

![img](https://img2020.cnblogs.com/blog/1953408/202103/1953408-20210328174936922-432159329.png)

- 防止用户虚拟机IP和MAC地址仿冒（IP和MAC绑定）
  - 防止虚拟机用户通过修改虚拟网卡的IP、MAC地址发起IP、MAC仿冒攻击，增强用户虚拟机的网络安全。通过生成IP-MAC的绑定关系，基于IP源侧防护(IP Source Guard)与动态ARP检测（DAI）对非绑定关系的报文进行过滤。
- 防止用户虚拟机DHCP Server仿冒（DHCP服务隔离）
  - 禁止用户虚拟机启动DHCP Server服务，防止用户无意识或恶意启动DHCP Server服务，影响正常的虚拟机IP地址分配过程。

##### 广播报文抑制

- 减少过量广播报文对二层网络带宽的消耗
- 管理员可以通过系统Portal，基于虚拟交换机端口组对象，配置报文抑制开关和报文抑制带宽阈值

##### 安全组

![img](https://img2020.cnblogs.com/blog/1953408/202103/1953408-20210328174920854-1847142384.png)

- 用户通过在创建虚拟机时选定要加入的安全组来对自身的虚拟机进行安全隔离和访问控制。

> 位于同一个安全组的所有虚拟机网卡都将使用该安全组规则进行网络通信。虚拟机一块网卡只能加入一个安全组中。

##### Trunk口

![img](https://img2020.cnblogs.com/blog/1953408/202103/1953408-20210328174909361-740611837.png)

- 虚拟机网卡通过虚端口接入虚拟交换机进行网络数据包的收发。
- 虚拟交换机虚端口支持配置为Trunk类型，并允许设置Trunk的VLAN ID范围，之后虚端口便具备了同时收发携带不同VLAN标签的网络数据包的功能，从而满足了虚拟网卡支持Trunk类型端口的需求。

##### 网络QoS

![img](https://img2020.cnblogs.com/blog/1953408/202103/1953408-20210328174856915-387486206.png)

- 基于端口组成员接口发送方向与接收方向的带宽控制。
- 基于端口组的每个成员接口提供流量整形、带宽优先级的控制能力。

##### 网口绑定

![img](https://img2020.cnblogs.com/blog/1953408/202103/1953408-20210328174844904-120004826.png)

- 管理员可以通过FusionCompute绑定CNA主机的网口，以提高网络的可靠性。
- 针对普通网卡和DPDK驱动的物理网卡均可以设置端口绑定。

> - 对于普通网卡，绑定模式可以选择以下几种：
>   - 主备
>   - 轮询
>   - 基于源目的IP和端口负荷分担
>   - 基于源目的MAC的负荷分担
>   - 基于源目的MAC的LACP
>   - 基于源目的IP的LACP
> - 对于支持DPDK驱动的物理网卡，绑定模式可以选择以下几种：
>   - DPDK驱动的主备模式
>   - DPDK驱动的基于源目的MAC的LACP模式
>   - DPDK驱动的基于源目的IP和端口的LACP模式

### [分布式](https://zhuanlan.zhihu.com/p/382966178)

### 定义

不同的业务模块部署在不同的服务器上或者同一个业务模块分拆多个子业务，部署在不同的服务器上，解决高并发的问题，提供可扩展性以及高可用性，业务中使用分布式的场景主要有分布式存储以及分布式计算。

分布式存储中可以将数据分片到多个节点上，不仅可以**提高性能（可扩展性）**，同时也可以**使用多个节点对同一份数据进行备份**。

#### 特点

1. 分布性：服务部署空间具有多样性
2. 并发性：程序运行过程中，并发性操作是很常见的。比如同一个分布式系统中的多个节点，同时访问一个共享资源。数据库、分布式存储
3. 无序性：进程之间的消息通信，会出现顺序不一致问题
4. 系统中涉及的各个节点并行地工作。
5. 这些节点的宕机事件是独立的。
6. 这些节点之间没有一个全局时钟，也就是说各个节点的本地物理时钟是有偏差的。

#### [优缺点](https://zhuanlan.zhihu.com/p/437482880)



![img](https://pic3.zhimg.com/80/v2-93fca31fe28daf594bba6f3d4cf47546_720w.webp)

### [SCSI、FC、iSCSI三大协议概述](https://zhuanlan.zhihu.com/p/34188712)

1. SCSI是小型计算机系统接口（Small Computer System Interface）的简称，于1979首次提出，是为小型机研制的一种接口技术，现在已完全普及到了小型机，高低端服务器以及普通PC上。
2. FC光纤通道：用于计算机设备之间数据传输，传输率达到2G（将来会达到4G）。光纤通道用于服务器共享存储设备的连接，存储控制器和驱动器之间的内部连接。
3. iSCSI（互联网小型计算机系统接口 Internet Small Computer System Interface）是一种在TCP/IP上进行数据块传输的标准。它是由Cisco和IBM两家发起的，并且得到了各大存储厂商的大力支持。iSCSI可以实现在IP网络上运行SCSI协议，使其能够在诸如高速千兆以太网上进行快速的数据存取备份操作。

### 内存虚拟化

1. 内存物理地址从0开始是什么意思？

   

2. 内存的连续性是什么？

   

3. 什么是内存映射？

   

### I/O虚拟化

[浅谈网络I/O全虚拟化、半虚拟化和I/O透传 - 简书 (jianshu.com)](https://www.jianshu.com/p/fc40104eba23)

1. 该方式采用**软件模拟真实硬件设备**。一个设备的所有功能或者总线结构（如设备枚举、识别、中断和DMA）等都可以在宿主机中模拟。而对客户机而言看到的是一个功能齐全的“真实”的硬件设备。其实现上通常需要宿主机上的软件配合截取客户机对I/O设备的各种请求，通过软件去模拟。比如：QEMU/KVM虚拟化中QEMU就可以通过模拟各种类型的网卡，这种方式的好处是**灵活，不需要专有驱动**，因此能实现既不需要修改客户机、也无需考虑底层硬件，对客户机透明地使用网络资源。但是缺点在于，很多中断信号的处理需要让客户机感觉到自己运行在一个“真实环境”，因此QEMU软件模拟的很底层，**效率低下**

2. 在这种虚拟化中，客户机操作系统能够感知到自己是虚拟机，I/O的虚拟化由前端驱动和后端驱动共同模拟实现。**在客户机中运行的驱动程序称之为前端，在宿主机上与前端通信的驱动程序称之为后端。前端发送客户机请求给后端，后端驱动处理完这些请求后再返回给前端。**而在不同的虚拟化机制中，这一过程的实现手段也有所区别，例如：Xen中的共享内存、授权表，KVM中的virtio。它相比于全虚拟化的好处在于，不再需要宿主机上专门的软件去模拟实现I/O请求，因此不会有VM-exit（虚拟机中断），性能会有所提升。

3. 对于性能的追求是永无止境的，除了上述全虚拟化、半虚拟化两种I/O虚拟化以外，还有一种非常极端的做法。让物理设备穿过宿主机、虚拟化层，直接被客户机使用，这种方式通常可以获取近乎native的性能。

   + 这种方式主要缺点是：
      **1.硬件资源昂贵且有限。**
      **2.动态迁移问题，宿主机并不知道设备的运行的内部状态，状态无法迁移或恢复**

4. 知识点补充

   驱动

   前端驱动和后端驱动

   虚拟机中的概念

   + 宿主机（主机）：指要安装虚拟机软件的计算机，你花钱买的物理机。

   + 虚拟机：利用虚拟机工具构造出来的，有一整套硬件设备，有自己操作系统，应用软件

   + 宿主操作系统：物理机上安装的，例如在一台Win2K机上安装[VMWare](https://so.csdn.net/so/search?q=VMWare&spm=1001.2101.3001.7020)

   + 客户操作系统：虚拟机上的操作系统，如Red Hat Linux。

## 计算机常见名词释义

1. cache 缓存
2. buffer 缓冲
3. OS 操作系统